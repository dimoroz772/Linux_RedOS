Установка/настройка контроллера домена Samba DC на OC Linux RedOS 7.3.1 Workstation
-----------------------------------------------------------------------------------------------------------------
https://redos.red-soft.ru/base/server-configuring/domain-config/install-samba-dc/
-----------------------------------------------------------------------------------------------------------------
При создании виртуаки рекомендуется выделить: Sockets: 2; Cores: 2; Memory(MiB): 8192.
-----------------------------------------------------------------------------------------------------------------
После установки рабочей станции, обязательно нужно прописать статику(пример):
IP-адрес: 192.168.88.165; Mask: 255.255.255.0(24); Gateway: 192.168.88.1; Серверы DNS: 77.88.8.88(ya.ru); Поисковый домен: test.local
-----------------------------------------------------------------------------------------------------------------
ifdown ens18 && ifup ens18 |#|#| Перезапуск сетевого интерфейса.
-----------------------------------------------------------------------------------------------------------------
yum update -y && yum upgrade -y |#|#| Поиск и обновление пакетов.
-----------------------------------------------------------------------------------------------------------------
reboot |#|#| Перезагрузка системы.
-----------------------------------------------------------------------------------------------------------------
yum install samba-client*.x86_64 samba-common.noarch samba-common*x86_64 samba-dc*.x86_64 samba-libs*.x86_64 samba-winbind*.x86_64 -y |#|#| Установка необходимых пакетов
-----------------------------------------------------------------------------------------------------------------
smbd -b | grep HAVE_LIBKADM5SRV_MIT |#|#| Проверка Samba на наличие Kerberos Heimdal. Если команда выдаёт "HAVE_LIBKADM5SRV_MIT", тогда нужно установить Samba с  поддержкой Kerberos Heimdal.
-----------------------------------------------------------------------------------------------------------------
mv /etc/krb5.conf /etc/krb5.conf.bak |#|#| Переименование дефолтного файла Kerberos.
-----------------------------------------------------------------------------------------------------------------
mv /etc/samba/smb.conf /etc/samba/smb.conf.bak |#|#| Переименование дефолтного файла Samba.
-----------------------------------------------------------------------------------------------------------------
smbd -V |#|#| Команда проверки установленной версии Samba.
-----------------------------------------------------------------------------------------------------------------
nano /etc/selinux/config |#|#| В файле config нужно поменять статус SElinux. Заменить текст SELINUX=enforcing на SELINUX=permissive.
setenforce 0
-----------------------------------------------------------------------------------------------------------------
hostnamectl set-hostname dc1.test.local |#|#| Смена имени сервера.
-----------------------------------------------------------------------------------------------------------------
nano /etc/hosts |#|#| В файле hosts нужно добавить ниже IP-адрес сервера, его полное и короткое имя.
Пример: 192.168.88.165 dc1.test.local dc1
-----------------------------------------------------------------------------------------------------------------
systemctl restart NetworkManager |#|#| Перезагразка сетевого интерфейса.
-----------------------------------------------------------------------------------------------------------------
cat /etc/resolv.conf |#|#| Проверка файла resolv.conf в прописанными dns-адресами.
Вывод должнен быть таким:
# Generated by NetworkManager
search test.local
nameserver 77.88.8.88
-----------------------------------------------------------------------------------------------------------------
samba-tool domain provision --use-rfc2307 --interactive |#|#| Запуск конфигурирования Samba в роли контроллера домена в интерактивном режиме.

Realm [TEST.LOCAL]:
Domain [TEST]:
Server Role (dc, member, standalone) [dc]: dc
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
DNS forwarder IP address (write 'none' to disable forwarding) [77.88.8.88]: 192.168.88.165
Administrator password:
Retype password:
Looking up IPv4 addresses
Looking up IPv6 addresses
No IPv6 address will be assigned
Setting up share.ldb
Setting up secrets.ldb
Setting up the registry
Setting up the privileges database
Setting up idmap db
Setting up SAM db
Setting up sam.ldb partitions and settings
Setting up sam.ldb rootDSE
Pre-loading the Samba 4 and AD schema
Unable to determine the DomainSID, can not enforce uniqueness constraint on local domainSIDs
Adding DomainDN: DC=skynet,DC=murom
Adding configuration container
Setting up sam.ldb schema
Setting up sam.ldb configuration data
Setting up display specifiers
Modifying display specifiers and extended rights
Adding users container
Modifying users container
Adding computers container
Modifying computers container
Setting up sam.ldb data
Setting up well known security principals
Setting up sam.ldb users and groups
Setting up self join
Adding DNS accounts
Creating CN=MicrosoftDNS,CN=System,DC=skynet,DC=murom
Creating DomainDnsZones and ForestDnsZones partitions
Populating DomainDnsZones and ForestDnsZones partitions
Setting up sam.ldb rootDSE marking as synchronized
Fixing provision GUIDs
The Kerberos KDC configuration for Samba AD is located at /var/lib/samba/private/kdc.conf
A Kerberos configuration suitable for Samba AD has been generated at /var/lib/samba/private/krb5.conf
Merge the contents of this file with your system krb5.conf or replace it with this one. Do not create a symlink!
Setting up fake yp server settings
Once the above files are installed, your Samba AD server will be ready to use
Server Role: active directory domain controller
Hostname:dc1
NetBIOS Domain:SKYNET
DNS Domain: skynet.murom
DOMAIN SID:S-1-5-21-4010603892-1310842104-1159347701
-----------------------------------------------------------------------------------------------------------------
После окончания конфигурирования контроллера домена, нужно зайти в настройки сетевого интерфейса и встроке "Серверы DNS" поменять адрес 77.88.8.88 на 127.0.0.1.
-----------------------------------------------------------------------------------------------------------------
nano /etc/samba/smb.conf |#|#| В файле smb.conf, раздел [global] нужно привести к следующему виду:
[global]
dns forwarder = 192.168.88.165
netbios name = DC1
realm= TEST.LOCAL
server role = active directory domain controller
workgroup= TEST
idmap_ldb:use rfc2307 = yes
vfs objects = acl_xattr
map acl inherit = yes
store dos attributes = yes
allow dns updates = nonsecure
nsupdate command = /usr/bin/nsupdate -g
dsdb:schema update allowed = true
-----------------------------------------------------------------------------------------------------------------
systemctl status samba.service |#|#| Проверка статуса Samba.
systemctl start samba.service |#|#| Запуск службы Samba.
systemctl enable samba.service |#|#| Добавление в автозапуск сервиса Samba
-----------------------------------------------------------------------------------------------------------------
reboot |#|#| Перезапуск системы
-----------------------------------------------------------------------------------------------------------------
cp /var/lib/samba/private/krb5.conf /etc/ |#|#| Копирование сконфигурированного файла Kerberos.
nano /etc/krb5.conf |#|#| Файл нужно привести к следующему виду:

[libdefaults]
default_realm = TEST.LOCAL
dns_lookup_realm = false
dns_lookup_kdc = true
ticket_lifetime = 24h
forwardable = yes

[realms]
TEST.LOCAL = {
  default_domain = test.local
}

[domain_realm]
  dc1 = TEST.LOCAL
-----------------------------------------------------------------------------------------------------------------
systemctl start winbind |#|#| Запуск службы winbind.
systemctl enable winbind |#|#| Добавление в автозапуск сервиса Winbind.
-----------------------------------------------------------------------------------------------------------------
reboot |#|#| Перезапуск системы.
