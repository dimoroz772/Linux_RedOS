<head>
    <title>Local repositories for RedOS 7 and RedOS 8</title>
    <link rel="shortcut icon" href="./RAID.png" type="image/png">
  </head>
   <head>
    <meta charset="utf-8">
   </head>
  <style>
  .neonText1 {
    color: #87CEFA;
    text-shadow:
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1,
        0 0 1px #4169E1;
  }
  .neonText2 {
    color: #00FF00;
    text-shadow:
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400,
        0 0 1px #006400;
  }
  /* Additional styling */
  body{
      background-color: black;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      color: #cfcfcf;
  }
  a {
      text-decoration: none;
  }
  p {
    text-indent: 1.5em;
    font-family: monospace;
    font-weight: 500;
    white-space: pre;
    line-height: 2;
    letter-spacing: 1px;
  }
  </style>
  <div class="container">
  <p class="neonText1">
    Создание локального репозитория для операционных систем RedOS 7 и RedOS 8.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    Все описанные ниже работы проводились на ОС RedOS 8 Server.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    Все действия описанные ниже выполнялись под пользователем root.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    Всем привет! Для реализации данного проекта мне потребовалось:

    1) Назначить статическую IP-адресацию;
    2) Обновить пакеты ОС Linux RedOS 8 Server до последней версии;
    3) Установить все нужные пакеты и запустить необходимые службы;
    4) Создание нужных каталогов, файлов репозиториев, загрузка пакетов на сервер и создание локального зеркала репозитория;
    5) Создание скриптов для обновления репозиториев и добавление их в Crontab;
    6) Пример подключения собственного локального репозитория на клиентском ПК.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    Предисловие:
    ------------
    Nano — это консольный текстовый редактор для UNIX и Unix-подобных операционных систем, основанный на библиотеке curses и распространяемый под лицензией GNU GPL.
    ------------
    NMTUI — это инструмент командной строки, который используется для настройки сети в системах Gnu / Linux. При запуске он вызывает графический текстовый 
    интерфейс, который помогает пользователям легко и эффективно настраивать сетевые интерфейсы.
    ------------
    Apache HTTP-сервер — это свободный веб-сервер.
    ------------
    Cron — это система для автоматического запуска программ и скриптов на сервере в определённое время.
    ------------
    Репозиторий — это место, где хранятся и поддерживаются какие-либо данные.
    ------------
    Repo id — это идентификационный номер репозитория.
    ------------
    10.10.10.10 — это IP-Address локального сервера с репозиториями.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    1) Для избежания потери связи с АРМ/VM, нужно позаботиться о статической IP-адресации. Её можно настроить как на самой АРМ/VM, так и на самом сетевом 
    устройстве. Статическую адресацию можно прописать с помощью инструмента командной строки nmtui.
    ------------
    <a class="neonText2">yum install -y NetworkManager-tui</a> |#|#| Установка пакета "nmtui" для настройки сети на АРМ/VM
    ------------
    Гайд по тому, как пользоваться инструментом nmtui, вы можете посмотреть в интернете.
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    2) Обновление пакетов системы.
    ------------
    <a class="neonText2">yum update -y && yum upgrade -y</a> |#|#| Поиск и обновление пакетов системы
    ------------
    <a class="neonText2">reboot</a> |#|#| Команда для перезагрузки АРМ/VM
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    3) Установка всех нужных пакетов и запуск необходимых служб.
    ------------
    <a class="neonText2">yum install -y httpd createrepo_c dnf-utils cronie</a> |#|#| Команда для установки всех нужных пакетов
    ------------
    <a class="neonText2">systemctl enable httpd --now</a> |#|#| Команда для запуска и добавления в автозагрузку службы httpd
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    4) Создание нужных каталогов, файлов репозиториев, загрузка пакетов на сервер и создание локального зеркала репозитория.
    ------------
    <a class="neonText2">mkdir /mnt/repodisk/</a> |#|#| Команда для создания каталога "/mnt/repodisk/"
    ------------
    <a class="neonText2">mkdir /var/www/html/repos/</a> |#|#| Команда для создания каталога "/var/www/html/repos/"
    ------------
    <a class="neonText2">ln -s /mnt/repodisk/ /var/www/html/repos/</a> |#|#| Команда для создания символической ссылки
    ------------
    <a class="neonText2">semanage fcontext -a -t httpd_sys_content_t "/mnt/repodisk(/.*)?"</a> |#|#| Команда для приминения правильного контекста SELinux, для файловых систем с поддержкой
    Extended File Attributes - ext2, ext3, ext4, jfs, xfs, btrfs
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Base.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Base.repo"

    Поменяйте в конце файла значение строки "<a class="neonText2">enabled=1</a>" на "<a class="neonText2">enabled=0</a>", после чего сохраните и закройте файл.
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Updates.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Updates.repo"
    ------------

    Поменяйте в конце файла значение строки "<a class="neonText2">enabled=1</a>" на "<a class="neonText2">enabled=0</a>", после чего сохраните и закройте файл.
    ------------
    <a class="neonText2">mkdir /root/def_repo/</a> |#|#| Команда для создания каталога "/root/def_repo/"
    ------------
    <a class="neonText2">mv /etc/yum.repos.d/RedOS-Base.repo /root/def_repo/</a> |#|#| Команда для переноса файла репозитория "RedOS-Base.repo" из каталога "/etc/yum.repos.d/" в каталог "/etc/yum.repos.d/"
    ------------
    <a class="neonText2">mv /etc/yum.repos.d/RedOS-Updates.repo /root/def_repo/</a> |#|#| Команда для переноса файла репозитория "RedOS-Updates.repo" из каталога "/etc/yum.repos.d/" в каталог "/etc/yum.repos.d/"
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_7_Base_SRC.repo</a> |#|#| Команда для создания файла репозитория "RedOS_7_Base_SRC.repo"

    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [base7]
    name=RedOS - Base
    baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/os,https://mirror.yandex.ru/redos/7.3/$basearch/os,http://repo.red-soft.ru/redos/7.3/$basearch/os
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">mkdir /var/www/html/repos/redos7/</a> |#|#| Команда для создания каталога "/var/www/html/repos/redos7/"
    ------------
    <a class="neonText2">cd /var/www/html/repos/redos7/</a> |#|#| Команда для перехода в ранее созданный каталог "/var/www/html/repos/redos7/"
    ------------
    <a class="neonText2">reposync --repoid=base7 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "RedOS - Base"

    После выполнения данной команды, в каталоге "/var/www/html/repos/redos7/" системно создастся папка "base7". Также, аналогично при выполнении команд "reposync*",
    будут создаваться и другие папки с названиями "repoid".
    При использовании дополнительного параметра <a class="neonText2">--newest-only</a> будут загружены только самые новые версии каждого пакета.
    Пример:

    <a class="neonText2">reposync --repoid=base7 --newest-only --downloadcomps</a> |#|#| Команда для загрузки только самых новых версий каждого пакета из репозитория "RedOS - Base"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos7/base7/ -g comps.xml</a> |#|#| Команда для формирования метаданных локального репозитория "base7"

    Параметр "<a class="neonText2">-g comps.xml</a>" используется только при создании локального репозитория RedOS - Base.
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_7_Updates_SRC.repo</a> |#|#| Команда для создания файла репозитория "RedOS_7_Updates_SRC.repo"
    
    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [updates7]
    name=RedOS - Updates
    baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/updates,https://mirror.yandex.ru/redos/7.3/$basearch/updates,http://repo.red-soft.ru/redos/7.3/$basearch/updates
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">reposync --repoid=updates7 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "RedOS - Updates"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos7/updates7/</a> |#|#| Команда для формирования метаданных локального репозитория "updates7"
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_7_Kernels_SRC.repo</a> |#|#| Команда для создания файла репозитория "RedOS_7_Kernels_SRC.repo"
    
    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [kernels7]
    name=Kernels updates for RED OS 7.3
    baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/kernels,https://mirror.yandex.ru/redos/7.3/$basearch/kernels,http://repo.red-soft.ru/redos/7.3/$basearch/kernels
    enabled=1
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT</a>
    ------------
    <a class="neonText2">reposync --repoid=kernels7 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "Kernels updates for RED OS 7.3"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos7/kernels7/</a> |#|#| Команда для формирования метаданных локального репозитория "kernels7"
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_7_Kernels6_src.repo</a> |#|#| Команда для создания файла репозитория "RedOS_7_Kernels6_src.repo"
    
    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [kernels6]
    name=Repositories for kernels6
    baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/extras/kernels6-73,https://mirror.yandex.ru/redos/7.3/$basearch/extras/kernels6-73,http://repo.red-soft.ru/redos/7.3/$basearch/extras/kernels6-73
    enabled=1
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT</a>
    ------------
    <a class="neonText2">reposync --repoid=kernels6 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "Repositories for kernels6"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos7/kernels6/</a> |#|#| Команда для формирования метаданных локального репозитория "kernels6"
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_8_Base_SRC.repo</a> |#|#| Команда для создания файла репозитория "RedOS_8_Base_SRC.repo"
    
    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [base8]
    name=RedOS - Base
    baseurl=https://repo1.red-soft.ru/redos/8.0/$basearch/os,https://mirror.yandex.ru/redos/8.0/$basearch/os,http://repo.red-soft.ru/redos/8.0/$basearch/os
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">mkdir -p /var/www/html/repos/redos8/</a> |#|#| Команда для создания каталога "/var/www/html/repos/redos8/"
    ------------
    <a class="neonText2">cd /var/www/html/repos/redos8/</a> |#|#| Команда для перехода в ранее созданный каталог "/var/www/html/repos/redos8/"
    ------------
    <a class="neonText2">reposync --repoid=base8 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "RedOS - Base"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos8/base8/ -g comps.xml</a> |#|#| Команда для формирования метаданных локального репозитория "base8"
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS_8_Updates_SRC.repo</a> |#|#| Команда для создания файла репозитория "RedOS_8_Updates_SRC.repo"
    
    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    [updates8]
    name=RedOS - Updates
    baseurl=https://repo1.red-soft.ru/redos/8.0/$basearch/updates,https://mirror.yandex.ru/redos/8.0/$basearch/updates,http://repo.red-soft.ru/redos/8.0/$basearch/updates
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">reposync --repoid=updates8 --download-metadata --downloadcomps</a> |#|#| Команда для загрузки пакетов из репозитория "RedOS - Updates"
    ------------
    <a class="neonText2">createrepo -v /var/www/html/repos/redos8/updates8/</a> |#|#| Команда для формирования метаданных локального репозитория "updates8"
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    5) Создание скриптов для обновления репозиториев и добавление их в Crontab.
    ------------
    <a class="neonText2">cd /root/</a> |#|#| Команда для перехода в каталог "/root/"
    ------------
    <a class="neonText2">nano repo7.sh</a> |#|#| Команда для создания конфигурационного bash-файла, который будет обновлять локальные репозитории RedOS 7

    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    #!/bin/bash
    DESTDIR=/var/www/html/repos/redos7
    REPOIDS="base7 updates7 kernels7 kernels6"
    dnf makecache
    for REPOID in $REPOIDS; do
        if [[ -f "$DESTDIR/$REPOID/.repodata" ]];
          then
             rm -rf $DESTDIR/$REPOID/.repodata
        fi
        reposync --repo $REPOID --newest-only --downloadcomps -p $DESTDIR
        if [[ -f "$DESTDIR/$REPOID/comps.xml" ]];
          then
             createrepo --update $DESTDIR/$REPOID -g comps.xml
          else
             createrepo --update $DESTDIR/$REPOID
        fi
    done</a>
    ------------
    <a class="neonText2">chmod 777 repo7.sh</a> |#|#| Команда для выдачи полных прав bash-файлу "repo7.sh"
    ------------
    <a class="neonText2">nano repo8.sh</a>

    Приведите файл репозитория к следующему виду:
    <a class="neonText2">
    #!/bin/bash
    DESTDIR=/var/www/html/repos/redos8
    REPOIDS="base8 updates8"
    dnf makecache
    for REPOID in $REPOIDS; do
        if [[ -f "$DESTDIR/$REPOID/.repodata" ]];
        then
            rm -rf $DESTDIR/$REPOID/.repodata
        fi
        reposync --repo $REPOID --newest-only --downloadcomps -p $DESTDIR
        if [[ -f "$DESTDIR/$REPOID/comps.xml" ]];
        then
            createrepo --update $DESTDIR/$REPOID -g comps.xml
        else
            createrepo --update $DESTDIR/$REPOID
        fi
    done</a>
    ------------
    <a class="neonText2">chmod 777 repo8.sh</a> |#|#| Команда для выдачи полных прав bash-файлу "repo8.sh"
    ------------
    <a class="neonText2">systemctl enable crond && systemctl start crond</a> |#|#| Команда для запуска и добавления в автозагрузку службы crond
    ------------
    <a class="neonText2">crontab -e</a> |#|#| Команда для открытия конфигурационного файла службы "crond"
    
    В примере ниже будут описаны две задачи в Crond, которые будут запускать скрипты "repo7.sh" в 01:30 и "repo8.sh" в 03:30, в каждое воскресенье.
    <a class="neonText2">
    30 1 * * 7 /root/repo7.sh
    30 3 * * 7 /root/repo8.sh</a>
    ------------
    <a class="neonText2">less /etc/crontab</a> |#|#| Команда для просмотра задач в Crond
    ------------
    <a class="neonText2">systemctl restart crond</a> |#|#| Команда для перезапуска службы "Crond"
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    6) Пример подключения собственного локального репозитория на клиентском ПК.
    ------------
                                                                            <a class="neonText2">RedOS 8</a>

    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Base.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Base.repo"

    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [base]
    name=RedOS - Base
    baseurl=http://10.10.10.10/repos/redos8/base8/
    #baseurl=https://repo1.red-soft.ru/redos/8.0/$basearch/os,https://mirror.yandex.ru/redos/8.0/$basearch/os,http://repo.red-soft.ru/redos/8.0/$basearch/os
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Updates.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Updates.repo"

    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [updates]
    name=RedOS - Updates
    baseurl=http://10.10.10.10/repos/redos8/updates8/
    #baseurl=https://repo1.red-soft.ru/redos/8.0/$basearch/updates,https://mirror.yandex.ru/redos/8.0/$basearch/updates,http://repo.red-soft.ru/redos/8.0/$basearch/updates
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
                                                                            <a class="neonText2">RedOS 7</a>

    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Base.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Base.repo"

    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [base]
    name=RedOS - Base
    baseurl=http://10.10.10.10/repos/redos7/base7/
    #baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/os,https://mirror.yandex.ru/redos/7.3/$basearch/os,http://repo.red-soft.ru/redos/7.3/$basearch/os
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-Updates.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-Updates.repo"
    
    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [updates]
    name=RedOS - Updates
    baseurl=http://10.10.10.10/repos/redos7/updates7/
    #baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/updates,https://mirror.yandex.ru/redos/7.3/$basearch/updates,http://repo.red-soft.ru/redos/7.3/$basearch/updates
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT
    enabled=1</a>
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-kernels6.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-kernels6.repo"

    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [kernels6]
    name=Repositories for kernels6
    baseurl=http://10.10.10.10/repos/redos7/kernels6/
    #baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/extras/kernels6-73,https://mirror.yandex.ru/redos/7.3/$basearch/extras/kernels6-73,http://repo.red-soft.ru/redos/7.3/$basearch/extras/kernels6-73
    enabled=1
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT</a>
    ------------
    <a class="neonText2">nano /etc/yum.repos.d/RedOS-kernels.repo</a> |#|#| Команда для редактирования файла репозитория "RedOS-kernels.repo"

    Приведите файл репозитория к следующему виду(где 10.10.10.10 — это IP-Address локального сервера с репозиториями):
    <a class="neonText2">
    [kernels]
    name=Kernels updates for RED OS 7.3
    baseurl=http://10.10.10.10/repos/redos7/kernels7/
    #baseurl=https://repo1.red-soft.ru/redos/7.3/$basearch/kernels,https://mirror.yandex.ru/redos/7.3/$basearch/kernels,http://repo.red-soft.ru/redos/7.3/$basearch/kernels
    enabled=1
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RED-SOFT</a>
    ------------

                                                                        <a class="neonText2">↓↓↓ Дополнительные команды ↓↓↓</a>
    
    <a class="neonText2">dnf repoinfo base7 | grep -iE 'размер.*репозитория'</a> |#|#| Команда для уточнения размера репозитория "base7"
    ------------
    <a class="neonText2">dnf repoinfo | grep -iE 'размер.*репозитория' | awk -F ':' '{size = $2; sub(/M$/, "", size); if (index($2, "M") > 0) total += size / 1024; else total += size} END {printf "Общий размер \033[41mвсех подключенных\033[0m репозиториев: %.2f G\n", total}'</a> |#| Команда для уточнения суммарного размера по всем подключенным репозиториям
    --------------------------------------------------------------------------------------------------------------------------------------------------------------
    На этом инструкция завершена! Всем спасибо за внимание!
  </p>
  </div>
